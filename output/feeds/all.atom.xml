<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>loaxsc's blog</title><link href="/" rel="alternate"></link><link href="/feeds/all.atom.xml" rel="self"></link><id>/</id><updated>2018-12-09T00:00:00+08:00</updated><entry><title>利用 FreePic2Pic 製作多層 PDF</title><link href="/li-yong-freepic2pic-zhi-zuo-duo-ceng-pdf.html" rel="alternate"></link><published>2018-12-09T00:00:00+08:00</published><updated>2018-12-09T00:00:00+08:00</updated><author><name>loaxsc</name></author><id>tag:None,2018-12-09:/li-yong-freepic2pic-zhi-zuo-duo-ceng-pdf.html</id><summary type="html">&lt;h1&gt;利用 FreePic2Pic 製作多層 PDF&lt;/h1&gt;
&lt;p&gt;在看 FreePic2Pdf 的說明文件時發現 FreePic2Pdf 有作多層 PDF 的功能，這功能使黑白文字混搭彩色插圖成為可能，我忍不任嘗試了一下。&lt;/p&gt;
&lt;p&gt;因為將文字部分轉成黑白圖片一定要放大效果才好，連帶著插圖也要放大。為了避免增加太多檔案體積，用 Imagemagick 放大插圖時採用 -scale 的方式。換句話說就是先用 -resize 把圖片放大一輪，然後找出有插圖的部分，用 -scale 放大後取出插圖，並將座標資料存入 page_with_pic.info 中。&lt;/p&gt;
&lt;p&gt;要用 FreePic2Pdf 做混搭的多層PDF的話，除了要製作FreePic2Pdf.itf這個文件，檔案命名還要符合它的要求。這個環節讓我卡超久，因為還有一個條件在 FreePic2Pdf 說明文件中沒提。它還要求多層頁面必須有一個同名的圖檔，就是說除了 page1.000 page1.001 page1.002 …&lt;/p&gt;</summary><content type="html">&lt;h1&gt;利用 FreePic2Pic 製作多層 PDF&lt;/h1&gt;
&lt;p&gt;在看 FreePic2Pdf 的說明文件時發現 FreePic2Pdf 有作多層 PDF 的功能，這功能使黑白文字混搭彩色插圖成為可能，我忍不任嘗試了一下。&lt;/p&gt;
&lt;p&gt;因為將文字部分轉成黑白圖片一定要放大效果才好，連帶著插圖也要放大。為了避免增加太多檔案體積，用 Imagemagick 放大插圖時採用 -scale 的方式。換句話說就是先用 -resize 把圖片放大一輪，然後找出有插圖的部分，用 -scale 放大後取出插圖，並將座標資料存入 page_with_pic.info 中。&lt;/p&gt;
&lt;p&gt;要用 FreePic2Pdf 做混搭的多層PDF的話，除了要製作FreePic2Pdf.itf這個文件，檔案命名還要符合它的要求。這個環節讓我卡超久，因為還有一個條件在 FreePic2Pdf 說明文件中沒提。它還要求多層頁面必須有一個同名的圖檔，就是說除了 page1.000 page1.001 page1.002...之外，還需要有一個 page1.png 或 page1.jpg 之類的圖檔，否則即使 FreePic2Pdf.itf 中有設定，而且檔案也存在，製作出來的 PDF 還是會缺頁。&lt;/p&gt;
&lt;p&gt;FreePic2Pdf 在製作 PDF 時應該是根據圖檔是否存在判斷有沒有該頁面，然後再配對 FreePic2Pdf.itf 中的設定決定如何處理。原本 FreePic2Pdf 是作者寫來處理 PDG 工具組的一部分，如果說一路跟上來，即使文件中沒註明，其他成員應該也猜得到，可是我是在網路上搜尋製作 PDF 的工具時找到了 FreePic2Pdf 就用了起來，我可沒辨法簡單地猜到。最後弄得沒辨法，是在網路上搜尋 PDG 檔案下來解開，才恍然大悟。&lt;/p&gt;
&lt;p&gt;我覺得編寫 FreePic2Pic.itf 實在太麻煩了，不過我已經累積了方法製作 page_with_pic.info，就想說用 python 寫個腳本把 page_with_pic.info 轉成 FreePic2Pic.itf，順便處理好檔名，以後要用到的話就直接轉換即可。&lt;/p&gt;
&lt;p&gt;腳本如下&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#! /usr/bin/python3&lt;/span&gt;
&lt;span class="c1"&gt;# -*- coding: utf-8 -*-&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;PIL&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Image&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nn"&gt;re&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nn"&gt;shutil&lt;/span&gt;


&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="vm"&gt;__name__&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;__main__&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;

    &lt;span class="n"&gt;f_in&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;page_with_pic.info&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;f_in&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;r&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;txt&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;strip&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="n"&gt;pre_im&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;
    &lt;span class="n"&gt;itf&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;txt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;findall&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;^page-\d{3}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt; &lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;pre_im&lt;/span&gt; &lt;span class="ow"&gt;and&lt;/span&gt; &lt;span class="n"&gt;pre_im&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;im&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;itf&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{}_000=0,0,{},{}&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s1"&gt;{}={}&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;pre_im&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;Image&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;pre_im&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;.png&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;pre_im&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;count&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;count&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;count&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;pre_im&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
        &lt;span class="n"&gt;itf&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sub&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;,(\d+)x(\d+)\+(\d+)\+(\d+)&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;_{:03d}=\3,\4,\1,\2&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;count&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;
        &lt;span class="n"&gt;pre_im&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;im&lt;/span&gt;

    &lt;span class="n"&gt;itf&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{}_000={},{},0,0&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s1"&gt;{}={}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;pre_im&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;Image&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;pre_im&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;.png&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;size&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;pre_im&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;count&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;f_out&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;FreePic2Pdf.itf&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;f_out&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;w&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;itf&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;iml&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sub&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;^(page-\d{3}),(.+)&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;\1_\2.png&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;txt&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flags&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;M&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;pre_im&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;iml&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;count&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;count&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;pre_im&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
        &lt;span class="n"&gt;shutil&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;copy&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;crop-pic/&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;im&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{}.{:03d}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;findall&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;^page-\d{3}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;count&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;pre_im&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;im&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;shutil&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;copy&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;findall&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;^page-\d{3}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;.png&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;re&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;findall&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="sa"&gt;r&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;^page-\d{3}&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;im&lt;/span&gt; &lt;span class="p"&gt;)[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;.000&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;將圖檔和 FreePic2Pic.itf 準備好後，用 FreePic2Pic 轉出來，效果還不錯，不輸其他的方法&lt;/p&gt;
&lt;p&gt;&lt;img alt=" txt2-pic16 的效果圖" src="/img/037.png"&gt;&lt;/p&gt;
&lt;p&gt;只是 PDF 的體積沒想像中的小。算了，就是一個嘗試而已。&lt;/p&gt;
&lt;p&gt;&lt;img alt=" txt2-pic16 的檔案尺寸 " src="/img/038.png"&gt;&lt;/p&gt;</content></entry><entry><title>移除浮水印的方法</title><link href="/yi-chu-fu-shui-yin-de-fang-fa.html" rel="alternate"></link><published>2018-12-09T00:00:00+08:00</published><updated>2018-12-09T00:00:00+08:00</updated><author><name>loaxsc</name></author><id>tag:None,2018-12-09:/yi-chu-fu-shui-yin-de-fang-fa.html</id><summary type="html">&lt;h1&gt;移除 watermark&lt;/h1&gt;
&lt;p&gt;常常在讀電子書時見到頁面中有浮水印，在沒接觸 Imagemagick 前，只會移除那種淡淡的、單色，只要簡單地提高對比度或亮度就可以移除的浮水印&lt;/p&gt;
&lt;p&gt;&lt;img alt="簡單的浮水印" src="/img/021.png"&gt;&lt;/p&gt;
&lt;p&gt;如果說遇到比較複雜的圖案，就只能默默的接受。在研究使用 Imagemagick 時意外發現兩種移除浮水印的方法，相對簡單的調整對比和亮度而言，可以說是移除的非常漂亮。 第一種方法針對的是在固定位置的浮水印，如果你可以找到用來做浮水印的原始圖片，那固定位置的浮水印是可以漂亮的移除的。第二種方法針對的是彩色的浮水印。電子書內的圖片因為主要的內容是黑白的文字，所以如果遇到彩色的浮水印，知道方法的話也是有辨法移除的。&lt;/p&gt;
&lt;h2&gt;移除固定位置的浮水印&lt;/h2&gt;
&lt;p&gt;移除固定位置浮水印的原理是這樣的，先找到原始做為浮水印的圖案，這很容易，因為電子書中有些浮水印會打在空白處，找到該處把浮水印擷取下即可取得浮水印的原始圖案。擷取時記得把擷取的位置和尺寸記下來，然後就可以編寫 Imagemagick 的指令下去批次把浮水印移除掉。&lt;/p&gt;
&lt;p&gt;拿《數學之美》第一章為例，這本電子書的浮水印在固定位置，而且不是簡單的單色、淡色，無法在不破壞文字的前提下靠調整對比、亮度或曲線來移除它。&lt;/p&gt;
&lt;p&gt;&lt;img alt="數學之美的浮水印，雖然位置固定，但是圖案的結構複雜" src="/img/016.png"&gt;&lt;/p&gt;
&lt;p&gt;我們先找到空白處的浮水印，擷取並記錄 geometry 資訊。我是用 gimp 來做這個步驟，因為用滑鼠大致選取好範圍後，可以利用方向鍵對選取方塊進行微調選取的尺寸及位置 …&lt;/p&gt;</summary><content type="html">&lt;h1&gt;移除 watermark&lt;/h1&gt;
&lt;p&gt;常常在讀電子書時見到頁面中有浮水印，在沒接觸 Imagemagick 前，只會移除那種淡淡的、單色，只要簡單地提高對比度或亮度就可以移除的浮水印&lt;/p&gt;
&lt;p&gt;&lt;img alt="簡單的浮水印" src="/img/021.png"&gt;&lt;/p&gt;
&lt;p&gt;如果說遇到比較複雜的圖案，就只能默默的接受。在研究使用 Imagemagick 時意外發現兩種移除浮水印的方法，相對簡單的調整對比和亮度而言，可以說是移除的非常漂亮。 第一種方法針對的是在固定位置的浮水印，如果你可以找到用來做浮水印的原始圖片，那固定位置的浮水印是可以漂亮的移除的。第二種方法針對的是彩色的浮水印。電子書內的圖片因為主要的內容是黑白的文字，所以如果遇到彩色的浮水印，知道方法的話也是有辨法移除的。&lt;/p&gt;
&lt;h2&gt;移除固定位置的浮水印&lt;/h2&gt;
&lt;p&gt;移除固定位置浮水印的原理是這樣的，先找到原始做為浮水印的圖案，這很容易，因為電子書中有些浮水印會打在空白處，找到該處把浮水印擷取下即可取得浮水印的原始圖案。擷取時記得把擷取的位置和尺寸記下來，然後就可以編寫 Imagemagick 的指令下去批次把浮水印移除掉。&lt;/p&gt;
&lt;p&gt;拿《數學之美》第一章為例，這本電子書的浮水印在固定位置，而且不是簡單的單色、淡色，無法在不破壞文字的前提下靠調整對比、亮度或曲線來移除它。&lt;/p&gt;
&lt;p&gt;&lt;img alt="數學之美的浮水印，雖然位置固定，但是圖案的結構複雜" src="/img/016.png"&gt;&lt;/p&gt;
&lt;p&gt;我們先找到空白處的浮水印，擷取並記錄 geometry 資訊。我是用 gimp 來做這個步驟，因為用滑鼠大致選取好範圍後，可以利用方向鍵對選取方塊進行微調選取的尺寸及位置，非常方便&lt;/p&gt;
&lt;p&gt;&lt;img alt="gimp 可以用方向鍵微調選取方塊" src="/img/022.png"&gt;&lt;/p&gt;
&lt;p&gt;微調完一切就緒後，因為 gimp 導出選取區域至檔案的操作太鎖碎了，我是直接複製到剪貼簿，再利用下面的指令把浮水印導出到檔案&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;xclip -selection clipboard -t image/png -o &amp;amp;gt; wmark.png
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;記得要把 geometry 資訊記錄下來，在視窗的左下角的工具選項中可以找到資訊。注意，gimp 的版面中上面是偏移位置，下面是寬度長度，我一開始沒注意到，導致後面的一直不對…&lt;/p&gt;
&lt;p&gt;&lt;img alt="gimp 中找到 geometry 資訊" src="/img/023.png"&gt;&lt;/p&gt;
&lt;p&gt;其實可以不用在 gimp 介面中找資訊再慢慢打，我在網上搜到將選取方塊的 geometry 資訊複製到剪貼簿的 &lt;a href="copy-selection-coordinates.py"&gt;python-fu 腳本&lt;/a&gt;，將這個腳本丟到 gimp plugin 資料夾中後，這個腳本會在選單中增加一個項目，再到 gimp 的設定中為該選單項目指定一個熱鍵即可。&lt;/p&gt;
&lt;p&gt;&lt;img alt="gimp選單項目" src="/img/024.png"&gt;&lt;/p&gt;
&lt;p&gt;在批次移除前先檢查一下頁面圖片的尺寸是否全部一致，打上浮水印的製作者可能不希望別人輕易就把浮水印移除，所以會故意把圖片的尺寸調整的不一致&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;identify page-???.* | cut -d &amp;#39; &amp;#39; -f 1,3 | \
    sort -n -k 2 | vim -R -c &amp;quot;set nu | nmap q :q&amp;amp;lt;cr&amp;amp;gt;&amp;quot; -
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;img alt="檢查圖片尺寸" src="/img/020.png"&gt;&lt;/p&gt;
&lt;p&gt;數學之美第一章圖片的尺寸相當一致。&lt;/p&gt;
&lt;p&gt;我們以下面的指令移除打在頁面上的浮水印&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# 移除浮水印的 Code
ls page-???.png | xargs -I _IMG_ \
convert _IMG_ -write mpr:src \
    -crop 291x363+691+1081 +repage -write mpr:src_s \
    wmark.png -compose difference -composite -threshold 0 -write mpr:mask +delete \
    mpr:src_s -mask mpr:mask -fill white +opaque white +mask -level 0%,100%,0.7 -write mpr:src_s +delete \
    mpr:src mpr:src_s -geometry +691+1081 -compose over -composite \
    ../01wmark/_IMG_
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;解釋一下上面的指令做了什麼：將頁面上對應的區塊和浮水印相減，這樣浮水印就被去掉了。可是這種方法會破壞被浮水印覆蓋的文字，所以需要再做進一步的處理。將去掉浮水印的圖案做成遮罩，&lt;/p&gt;
&lt;p&gt;&lt;img alt="浮水印消失啦！" src="/img/025.png"&gt;&lt;/p&gt;
&lt;h2&gt;移除彩色的浮水印&lt;/h2&gt;
&lt;p&gt;有些電子書上會打上彩色的浮水印，移除的原理其也不難，就抓住一個要點：電子書上的文字通常都是灰階的，因此構成文字的像素 RGB 值差距不大，通常在正負10(0 ~ 255)內，否則肉眼就會察覺出彩度來，這樣只要去檢查頁面中像素 RGB 之間的差值，太大的就替代成白色，就可以把浮水印移除掉了。&lt;/p&gt;
&lt;p&gt;&lt;img alt="一個彩水浮水印的例子" src="/img/017.png"&gt;&lt;/p&gt;
&lt;p&gt;ImageMagick 移除浮水印的指令&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;convert wmark.png -fx &amp;#39;p.r &amp;amp;gt; 0.692 &amp;amp;amp;&amp;amp;amp; abs(p.r - p.b) &amp;amp;gt; 0.0392 ? white : p&amp;#39; \
    wmark.png \
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;img alt="移除浮水印後的圖案" src="/img/018.png"&gt;&lt;/p&gt;
&lt;p&gt;這種方法來移除浮水印會留下很多雜點，還需要進一步的處理&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;convert wmark.png -write mpr:pic -threshold 75% \
    -define connected-components:area-threshold=6 \
    -connected-components 4 -threshold 0 -write mpr:mask +delete \
    mpr:pic -mask mpr:mask -fill white +opaque white wmark.png
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;img alt="進一步處理後的圖案" src="/img/019.png"&gt;&lt;/p&gt;
&lt;p&gt;很漂亮的移除了&lt;/p&gt;</content></entry><entry><title>優化 PDF 的檔案體積</title><link href="/you-hua-pdf-de-dang-an-ti-ji.html" rel="alternate"></link><published>2018-12-09T00:00:00+08:00</published><updated>2018-12-09T00:00:00+08:00</updated><author><name>loaxsc</name></author><id>tag:None,2018-12-09:/you-hua-pdf-de-dang-an-ti-ji.html</id><summary type="html">&lt;h1&gt;優化 PDF 的檔案體積&lt;/h1&gt;
&lt;h2&gt;為什麼想要研究這個問題&lt;/h2&gt;
&lt;p&gt;之前重新調整過頁面的排版後發現檔案的體積變大了，而且仔細看一下，可以發現有些頁面，文字變得比較模糊。重新檢查一下自己處理的步驟，原來是用 CEP 取內容時勾選了 deskew ，圖片的格式跑掉了。我想了一下，乾脆探索一下怎麼優化檔案體積，找出在盡可能保持頁面的視覺品質下縮減檔案體積的方法。&lt;/p&gt;
&lt;p&gt;如果是PNG格式的圖片，那影響檔案體積最重要的參數就是顏色的數量，先分析了一下原始檔，看看原製作者用的是怎麼樣校調的：&lt;/p&gt;
&lt;p&gt;&lt;img alt="原始檔使用的顏色數" src="/img/026.png"&gt;&lt;/p&gt;
&lt;p&gt;還真奇怪，因為畫面看起來不像是顏色豐富的感覺，我猜可能是浮水印的關係，把浮水印移除後再重新分析一次&lt;/p&gt;
&lt;p&gt;&lt;img alt="移除浮水印後，純文字部分使用的顏色數" src="/img/027.png"&gt;&lt;/p&gt;
&lt;p&gt;所以，原製作者他最終是把頁面處理成15色的圖檔，只是因為後來打上浮水印的關係使顏色數暴增，不過因為浮水印只佔一小區塊，所以即使顏色數變得混亂，檔案的體積倒是增加的不大。&lt;/p&gt;
&lt;p&gt;如果想進一步縮減檔案的體積，我想到兩個途徑，一個是把每頁文字的部分再進一部轉成 4 色而圖片保持 15 色；另一個途徑是把整張圖片轉成黑白的。&lt;/p&gt;
&lt;h2&gt;方法一：文字４色，插圖１５色&lt;/h2&gt;
&lt;p&gt;先把原始檔中有插圖的頁面找出來，將插圖的位置、大小資訊記錄在 page_with_pic.info 中，然後把插圖和文字分開。&lt;/p&gt;
&lt;p&gt;將文字和插圖分開的 …&lt;/p&gt;</summary><content type="html">&lt;h1&gt;優化 PDF 的檔案體積&lt;/h1&gt;
&lt;h2&gt;為什麼想要研究這個問題&lt;/h2&gt;
&lt;p&gt;之前重新調整過頁面的排版後發現檔案的體積變大了，而且仔細看一下，可以發現有些頁面，文字變得比較模糊。重新檢查一下自己處理的步驟，原來是用 CEP 取內容時勾選了 deskew ，圖片的格式跑掉了。我想了一下，乾脆探索一下怎麼優化檔案體積，找出在盡可能保持頁面的視覺品質下縮減檔案體積的方法。&lt;/p&gt;
&lt;p&gt;如果是PNG格式的圖片，那影響檔案體積最重要的參數就是顏色的數量，先分析了一下原始檔，看看原製作者用的是怎麼樣校調的：&lt;/p&gt;
&lt;p&gt;&lt;img alt="原始檔使用的顏色數" src="/img/026.png"&gt;&lt;/p&gt;
&lt;p&gt;還真奇怪，因為畫面看起來不像是顏色豐富的感覺，我猜可能是浮水印的關係，把浮水印移除後再重新分析一次&lt;/p&gt;
&lt;p&gt;&lt;img alt="移除浮水印後，純文字部分使用的顏色數" src="/img/027.png"&gt;&lt;/p&gt;
&lt;p&gt;所以，原製作者他最終是把頁面處理成15色的圖檔，只是因為後來打上浮水印的關係使顏色數暴增，不過因為浮水印只佔一小區塊，所以即使顏色數變得混亂，檔案的體積倒是增加的不大。&lt;/p&gt;
&lt;p&gt;如果想進一步縮減檔案的體積，我想到兩個途徑，一個是把每頁文字的部分再進一部轉成 4 色而圖片保持 15 色；另一個途徑是把整張圖片轉成黑白的。&lt;/p&gt;
&lt;h2&gt;方法一：文字４色，插圖１５色&lt;/h2&gt;
&lt;p&gt;先把原始檔中有插圖的頁面找出來，將插圖的位置、大小資訊記錄在 page_with_pic.info 中，然後把插圖和文字分開。&lt;/p&gt;
&lt;p&gt;將文字和插圖分開的 bash script&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;test -d crop-pic || mkdir crop-pic
while read line; do
    base=&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;.png
    geo=&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="c1"&gt;#*,&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;
    pic=crop-pic/&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;_&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="c1"&gt;#*,&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;.png

    echo &amp;quot;processing &lt;span class="nv"&gt;$base&lt;/span&gt;&amp;quot;

    # crop-pic
    convert &lt;span class="nv"&gt;$base&lt;/span&gt; -write mpr:src \
        -crop &lt;span class="nv"&gt;$geo&lt;/span&gt; +repage -write &lt;span class="nv"&gt;$pic&lt;/span&gt; +delete \
        mpr:src -region &lt;span class="nv"&gt;$geo&lt;/span&gt; -fill white -colorize 100 &lt;span class="nv"&gt;$base&lt;/span&gt;

done &lt;span class="ni"&gt;&amp;amp;lt;&lt;/span&gt; page_with_pic.info
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;要對文字做減色前先做顏色樣本 gray4.png&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;convert xc:&amp;#39;rgb(0,0,0)&amp;#39; xc:&amp;#39;rgb(85,85,85)&amp;#39; \
        xc:&amp;#39;rgb(170,170,170)&amp;#39; xc:&amp;#39;rgb(255,255,255)&amp;#39; \
        +append gray4.png
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;然後將只有文字的圖片減成四色&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;test -d colors || mkdir colors
ls page-???.png | xargs -I _IMG_ convert _IMG_ \
    -print &amp;#39;processing %f\n&amp;#39; +dither -remap gray4.png \
    png8:_IMG_
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;最後把插圖合併回來&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;while read line; do
    base=&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;.png
    geo=&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="c1"&gt;#*,&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;
    pic=crop-pic/&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;_&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="c1"&gt;#*,&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;.png

    convert &lt;span class="nv"&gt;$base&lt;/span&gt; &lt;span class="nv"&gt;$pic&lt;/span&gt; \
        -geometry &lt;span class="nv"&gt;$geo&lt;/span&gt; -compose over -composite png8:&lt;span class="nv"&gt;$base&lt;/span&gt;
done &lt;span class="ni"&gt;&amp;amp;lt;&lt;/span&gt; page_with_pic.info
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;利用 optipng 優化 png 的編碼&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;optipng page-???.png
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;最後利用 FreePic2Pdf 將圖檔合併成 PDF，新檔案和原始檔畫面並沒有差很多&lt;/p&gt;
&lt;p&gt;&lt;img alt="新檔案和原始檔畫面並沒有差很多" src="/img/029.png"&gt;&lt;/p&gt;
&lt;p&gt;不過檔案體積下降了不少&lt;/p&gt;
&lt;p&gt;&lt;img alt="不過檔案體積下降了不少" src="/img/030.png"&gt;&lt;/p&gt;
&lt;h2&gt;黑白圖檔&lt;/h2&gt;
&lt;p&gt;另一個途徑是將頁面轉成黑白雙色。&lt;/p&gt;
&lt;p&gt;用黑白圖片來做電子書也可以取得很好的效果，但前提是圖片的解析度要夠大。如果原始檔解析度不夠高，那利用放大、模糊、銳化三個步驟處理圖片，處理後雖然可能文字會有點變形，但是依舊能取得很好的效果。&lt;/p&gt;
&lt;p&gt;原始的圖檔解析度不是很大，如果直接轉黑白圖片效果會很糟，先將圖片放大３倍&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mogrify -print &amp;#39;processing %f\n&amp;#39; -resize 300% page-???.png
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;要用黑白圖檔做 PDF 電子書，視覺效果要好，插圖和文字必須分開處理，還是老樣子，把插圖的位置和大小資訊記錄在 page_with_pic.info ，然後將插圖和文字分開來。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;test -d crop-pic || mkdir crop-pic
while read line; do
    base=&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;.png
    geo=&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="c1"&gt;#*,&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;
    pic=crop-pic/&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;_&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="c1"&gt;#*,&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;.png

    echo &amp;quot;processing &lt;span class="nv"&gt;$base&lt;/span&gt;&amp;quot;

    # crop-pic
    convert &lt;span class="nv"&gt;$base&lt;/span&gt; -write mpr:src \
        -crop &lt;span class="nv"&gt;$geo&lt;/span&gt; +repage -write &lt;span class="nv"&gt;$pic&lt;/span&gt; +delete \
        mpr:src -region &lt;span class="nv"&gt;$geo&lt;/span&gt; -fill white -colorize 100 &lt;span class="nv"&gt;$base&lt;/span&gt;

done &lt;span class="ni"&gt;&amp;amp;lt;&lt;/span&gt; page_with_pic.info
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;轉換文字&lt;/h2&gt;
&lt;p&gt;我在轉換文字部分的圖檔都是利用 CEP，因為 CEP 裡面有一個 wolf 演算法，在轉換時稍微調整一下 wolf 演算法的參數，那轉換出來的效果明顯好過用其它的工具，尤其是圖片的亮度分佈不均勻時，差別非常大。&lt;/p&gt;
&lt;p&gt;將圖片放大後，在將圖片轉成黑白時有一種叫偽高清的方法，就是先將圖片模糊後再強力銳化，利用強力銳化時產生的邊緣效果將文字邊緣切割出來，雖然文字會有些變形，但是邊緣非常清淅。&lt;/p&gt;
&lt;p&gt;&lt;img alt="wolf vs 原始圖檔 vs 偽高清" src="/img/032.png"&gt;&lt;/p&gt;
&lt;p&gt;看個人喜好，我是比較偏好單純用 wolf 轉出來的效果。&lt;/p&gt;
&lt;h2&gt;轉換圖片&lt;/h2&gt;
&lt;p&gt;將插圖轉成黑白圖片時要採用 dither 的方式，dither 會用不同密度的點來代替灰階，如果沒經過這道手續直接轉黑白兩色，出來的結果圖片中的內容到底是什麼根本難以辨視。Imagemagick 中可選用的 dither 的方法有 Riemersma 和 FloydSteinberg 兩種，我是偏好 Floydsteinberg&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ls *.png | xargs -I _IMG_ \
    convert _IMG_ -dither floydsteinberg -remap pattern:gray50 _IMG_
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;img alt="Riemersma vs 原始圖檔 vs Floydsteinberg " src="/img/033.png"&gt;&lt;/p&gt;
&lt;p&gt;將插圖合併回來&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;while read line; do
    base=&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;.png
    geo=&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="c1"&gt;#*,&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;
    pic=crop-pic/&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;_&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="c1"&gt;#*,&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;.png

    convert &lt;span class="nv"&gt;$base&lt;/span&gt; &lt;span class="nv"&gt;$pic&lt;/span&gt; \
        -geometry &lt;span class="nv"&gt;$geo&lt;/span&gt; -compose over -composite png8:&lt;span class="nv"&gt;$base&lt;/span&gt;
done &lt;span class="ni"&gt;&amp;amp;lt;&lt;/span&gt; page_with_pic.info
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;直接用 FreePic2Pdf 將圖片合併成 PDF，FreePic2Pdf 對 BiLevel 的圖檔有作優化，採用 JBig2 算法，合併出來的檔案體積會進一步壓縮。&lt;/p&gt;
&lt;p&gt;勾選 FreePic2Pdf JBig2 算法&lt;/p&gt;
&lt;p&gt;&lt;img alt="勾選 FreePic2Pdf JBig2 算法" src="/img/034.png"&gt;&lt;/p&gt;
&lt;p&gt;原始檔 vs Bilevel的效果比較&lt;/p&gt;
&lt;p&gt;&lt;img alt="原始檔 vs Bilevel的效果比較" src="/img/035.png"&gt;&lt;/p&gt;
&lt;p&gt;檔案體積的比較&lt;/p&gt;
&lt;p&gt;&lt;img alt="檔案體積的比較" src="/img/036.png"&gt;&lt;/p&gt;</content></entry><entry><title>製作電子書的流程</title><link href="/zhi-zuo-dian-zi-shu-de-liu-cheng.html" rel="alternate"></link><published>2018-12-09T00:00:00+08:00</published><updated>2018-12-09T00:00:00+08:00</updated><author><name>loaxsc</name></author><id>tag:None,2018-12-09:/zhi-zuo-dian-zi-shu-de-liu-cheng.html</id><summary type="html">&lt;h1&gt;Title&lt;/h1&gt;
&lt;h2&gt;現實&lt;/h2&gt;
&lt;p&gt;我一直是有閱讀電子書的習慣，讀久了就會開始覺得有些電子書的排版和自己的閱讀習慣不是很合拍，譬如：&lt;/p&gt;
&lt;p&gt;&lt;img alt="內容不連貫的電子書" src="/img/002.png"&gt;&lt;/p&gt;
&lt;p&gt;這本書的頁面算是處理得非常好的，大部分的人閱讀起來應該不會有什麼怨言，可是我會希望自己在閱讀時能全神貫注在理解內容上，不希望自己的注意力被分散出去，可是注意到頁面中的內容是不連貫的，那種不連貫就讓我感到很不順眼。這種不連貫雖然很細微，但是會增加人在閱讀時負擔，當你全神貫注在理解內容時，你還必須耗費額外的心力來調整自己視線往返的範圍，而且因為我在做筆記時習慣直接把字打在頁面空白處，這種不一致的排版有時候會找不到地方放筆記，悶啊。&lt;/p&gt;
&lt;p&gt;我原本是用 CEP 來解決這個問題的，CEP就是 ComicEnhancer Pro，原本是作者寫來處理漫畫頁面的，經過時間的演進，慢慢變成很適合處理電子書版面的問題。經過一翻嘗試後我大致上是把版面安排成這樣&lt;/p&gt;
&lt;p&gt;&lt;img alt="用 CEP 修正過的版面" src="/img/004.png"&gt;&lt;/p&gt;
&lt;p&gt;這樣子的話內容是連貫下來的，而且右邊預留了足夠的空間可以做筆記&lt;/p&gt;
&lt;p&gt;大部分的時候我都很滿意這樣的效果，但還是會碰到一些解決不了的情況，譬如說有些書是有註解的，有註解也就算了，排版還分左右頁，左右頁的註解還不同邊&lt;/p&gt;
&lt;p&gt;&lt;img alt="註解在左右邊界的電子書" src="/img/005.png"&gt;&lt;/p&gt;
&lt;p&gt;還有時會遇到內容只有一點點，整個頁面留了一片空白&lt;/p&gt;
&lt;p&gt;&lt;img alt="留有大段空白的頁面" src="/img/003.png"&gt;&lt;/p&gt;
&lt;p&gt;你會覺得那不是必要的，可是用 CEP 並不好處理，雖然不是不能處理，但要採取非常多步驟，非常費工。CEP 是圖形介面的軟體，它有些功能藏在介面的深處，當你需要用到時，常常讓人覺得我只是要做個小處理 …&lt;/p&gt;</summary><content type="html">&lt;h1&gt;Title&lt;/h1&gt;
&lt;h2&gt;現實&lt;/h2&gt;
&lt;p&gt;我一直是有閱讀電子書的習慣，讀久了就會開始覺得有些電子書的排版和自己的閱讀習慣不是很合拍，譬如：&lt;/p&gt;
&lt;p&gt;&lt;img alt="內容不連貫的電子書" src="/img/002.png"&gt;&lt;/p&gt;
&lt;p&gt;這本書的頁面算是處理得非常好的，大部分的人閱讀起來應該不會有什麼怨言，可是我會希望自己在閱讀時能全神貫注在理解內容上，不希望自己的注意力被分散出去，可是注意到頁面中的內容是不連貫的，那種不連貫就讓我感到很不順眼。這種不連貫雖然很細微，但是會增加人在閱讀時負擔，當你全神貫注在理解內容時，你還必須耗費額外的心力來調整自己視線往返的範圍，而且因為我在做筆記時習慣直接把字打在頁面空白處，這種不一致的排版有時候會找不到地方放筆記，悶啊。&lt;/p&gt;
&lt;p&gt;我原本是用 CEP 來解決這個問題的，CEP就是 ComicEnhancer Pro，原本是作者寫來處理漫畫頁面的，經過時間的演進，慢慢變成很適合處理電子書版面的問題。經過一翻嘗試後我大致上是把版面安排成這樣&lt;/p&gt;
&lt;p&gt;&lt;img alt="用 CEP 修正過的版面" src="/img/004.png"&gt;&lt;/p&gt;
&lt;p&gt;這樣子的話內容是連貫下來的，而且右邊預留了足夠的空間可以做筆記&lt;/p&gt;
&lt;p&gt;大部分的時候我都很滿意這樣的效果，但還是會碰到一些解決不了的情況，譬如說有些書是有註解的，有註解也就算了，排版還分左右頁，左右頁的註解還不同邊&lt;/p&gt;
&lt;p&gt;&lt;img alt="註解在左右邊界的電子書" src="/img/005.png"&gt;&lt;/p&gt;
&lt;p&gt;還有時會遇到內容只有一點點，整個頁面留了一片空白&lt;/p&gt;
&lt;p&gt;&lt;img alt="留有大段空白的頁面" src="/img/003.png"&gt;&lt;/p&gt;
&lt;p&gt;你會覺得那不是必要的，可是用 CEP 並不好處理，雖然不是不能處理，但要採取非常多步驟，非常費工。CEP 是圖形介面的軟體，它有些功能藏在介面的深處，當你需要用到時，常常讓人覺得我只是要做個小處理，怎麼要按那麼多次滑鼠，做那麼多操作？&lt;/p&gt;
&lt;p&gt;還有些時候需要利用 CEP 對圖片進行優化時，CEP 是沒有辨法讓你調整處理的順序，如果你想採取的步驟和它預設的不同，你就得分次做…這讓人超悶的。&lt;/p&gt;
&lt;p&gt;後來注意到 Imagemagick ，想說試一下 Imagemagick，我原本只是用來切切邊界、縮放圖片而已，一時好奇就研究一下，發現我需要的功能它大部分都可以實現，乾脆花時間把自己的需要把功能都校調出來，往後要處理 PDF 的問題時就輕鬆了。&lt;/p&gt;
&lt;h2&gt;期待&lt;/h2&gt;
&lt;p&gt;大概總結一下自己閱讀時對版面的期待如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;希望內文是連貫的&lt;/li&gt;
&lt;li&gt;希望內容要維持密度，不要一段內容結束了，還要捲動一大段才接下一段內容&lt;/li&gt;
&lt;li&gt;左右邊有註解的話，註解在左邊&lt;/li&gt;
&lt;li&gt;希望右邊有空白可以做筆記&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;解決方案&lt;/h2&gt;
&lt;p&gt;以吳軍的《數學之美》第一章做為素材進行實驗&lt;/p&gt;
&lt;h3&gt;將圖片從 PDF 檔中取出&lt;/h3&gt;
&lt;p&gt;先利用 pdfimages 把圖片解出來&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt; -d 00src &lt;span class="o"&gt;||&lt;/span&gt; mkdir 00src
pdfimages -f &lt;span class="m"&gt;28&lt;/span&gt; -l &lt;span class="m"&gt;41&lt;/span&gt; -png -j -p 數學之美.pdf 00src/page
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;pdfimages 從 PDF 中解出圖片時會在檔名尾端加入編號，這樣會造成接下來寫腳本操作時不方便，先移除尾端編號&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;for&lt;/span&gt; _IMG_ in page-???.* &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; mv &lt;span class="nv"&gt;$_IMG_&lt;/span&gt; &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;_IMG_&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nv"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nv"&gt;8&lt;/span&gt;&lt;span class="si"&gt;}${&lt;/span&gt;&lt;span class="nv"&gt;_IMG_&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nv"&gt;12&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;done&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;有浮水印，&lt;a href="rm_wmark.html"&gt;拿掉它&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;將內容從圖片中取出&lt;/h3&gt;
&lt;p&gt;先用 CEP 把內容取出來，CEP 在取頁面內容這部分的能力是非常強悍的，在取內容時會遇到的問題譬如頁面有黑邊，頁面中有暗點，還有彩圖取內容的問題，CEP 都一一克服了，讓你基本上只要稍微設一下邊界，勾幾個選項，剩下的就交給 CEP 自動處理即可。頁碼沒什麼用，而且會增加接下來排版時的複雜度，在這邊設定手動邊界去掉它。&lt;/p&gt;
&lt;p&gt;&lt;img alt="用 CEP 取內容" src="/img/013.png"&gt;&lt;/p&gt;
&lt;p&gt;因為 CEP 切邊時擔心切到內容，因此會做邊緣補償，內容的四周會有多餘的白邊，先切掉白邊免得影響我們接下來的操作。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mogrify -print &amp;quot;processing %f&amp;quot; -trim +repage page-???.png
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;將圖片分類&lt;/h3&gt;
&lt;p&gt;把內容取出來後因為接下來調整版面的操作不一樣，要先圖片分類，基本上分三類：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;只有內容的頁面&lt;/li&gt;
&lt;li&gt;有左邊註解的頁面&lt;/li&gt;
&lt;li&gt;有右邊註解的頁面。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;我想偷懶，不太想自己人工分類，觀察一下圖片發現其實是可以依據一些特徵用腳本自動分類的。首先只有內容的圖片的寬度會明顯比有註解的頁面小，再來左邊註解的頁面檔案的編號固定是奇數，而右邊註解的頁面編號固定是偶數，依據這些就可以寫腳本來自動分類。&lt;/p&gt;
&lt;p&gt;下面的指令依據圖片的寬度排序列出圖片的資訊，。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;identify page-???.* &lt;span class="p"&gt;|&lt;/span&gt; cut -d &lt;span class="s1"&gt;&amp;#39; &amp;#39;&lt;/span&gt; -f &lt;span class="m"&gt;1&lt;/span&gt;,3 &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
    sort -n -k &lt;span class="m"&gt;2&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; vim -R -c &lt;span class="s2"&gt;&amp;quot;set nu | nmap q :q &amp;amp;lt;cr&amp;amp;gt;&amp;quot;&lt;/span&gt; -
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;img alt="列出圖片寬度" src="/img/006.png"&gt;&lt;/p&gt;
&lt;p&gt;可以發現說寬度一下子由 684 跳到 833 ，因此大致估算內容的 width 為 700 px。用下面的指令自動把符合條件的圖片移到 mid 資料夾&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt; -d mid &lt;span class="o"&gt;||&lt;/span&gt; mkdir mid
identify page-???.* &lt;span class="p"&gt;|&lt;/span&gt; cut -f &lt;span class="m"&gt;1&lt;/span&gt;,3 -d &lt;span class="s1"&gt;&amp;#39; &amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; cut -f &lt;span class="m"&gt;1&lt;/span&gt; -d &lt;span class="s1"&gt;&amp;#39;x&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="nb"&gt;read&lt;/span&gt; line&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;
    &lt;span class="nv"&gt;pic&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;line&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nv"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nv"&gt;12&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
    &lt;span class="nv"&gt;width&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;line&lt;/span&gt;&lt;span class="p"&gt;#* &lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; &lt;span class="nv"&gt;$width&lt;/span&gt; -le &lt;span class="m"&gt;700&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
        mv &lt;span class="nv"&gt;$pic&lt;/span&gt; mid
    &lt;span class="k"&gt;fi&lt;/span&gt;
&lt;span class="k"&gt;done&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;處理完單純只有內容的頁面後，再利用下面的指令來幫我們自動將有右註解的頁面分到 RP，有左註解的頁面分到 LP：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt; -d RP &lt;span class="o"&gt;||&lt;/span&gt; mkdir RP
mv page-*&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;,4,6,8,0&lt;span class="o"&gt;}&lt;/span&gt;.png RP &lt;span class="m"&gt;2&lt;/span&gt;&lt;span class="p"&gt;&amp;amp;&lt;/span&gt;gt&lt;span class="p"&gt;;&lt;/span&gt; /dev/null

&lt;span class="nb"&gt;test&lt;/span&gt; -d LP &lt;span class="o"&gt;||&lt;/span&gt; mkdir LP
mv page-*&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;,3,5,7,9&lt;span class="o"&gt;}&lt;/span&gt;.png LP &lt;span class="m"&gt;2&lt;/span&gt;&lt;span class="p"&gt;&amp;amp;&lt;/span&gt;gt&lt;span class="p"&gt;;&lt;/span&gt; /dev/null
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;用指令大致將檔案分類後，先用看圖軟體檢查一下看看有沒有錯誤再繼續進行下去。&lt;/p&gt;
&lt;h3&gt;重新配置內容版面&lt;/h3&gt;
&lt;p&gt;接下來我們要把版面整理好，像這樣固定將註解配置在左邊。&lt;/p&gt;
&lt;p&gt;&lt;img alt="內容版面樣版" src="/img/007.png"&gt;&lt;/p&gt;
&lt;p&gt;剛剛利用圖片寬度排序時從 684 直接跳 833，這樣的話大致可以推算註解欄的寬度是 150px，不過因為註解與內文之間還有空白間隔，因此取 140px，利用下面指令抓 5 張圖檢查一下&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# 檢查 LP 圖片&lt;/span&gt;
ls page-???.* &lt;span class="p"&gt;|&lt;/span&gt; sed 5q &lt;span class="p"&gt;|&lt;/span&gt; convert @- -extent &lt;span class="m"&gt;140&lt;/span&gt; x:

&lt;span class="c1"&gt;# 檢查 RP 圖片&lt;/span&gt;
ls page-???.* &lt;span class="p"&gt;|&lt;/span&gt; sed 5q &lt;span class="p"&gt;|&lt;/span&gt; convert @- -gravity east -extent &lt;span class="m"&gt;140&lt;/span&gt; x:
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;排版 RP&lt;/h4&gt;
&lt;p&gt;檢查好沒問題後，先處理右頁，把註解調整到左邊。&lt;/p&gt;
&lt;p&gt;在調整前要先思考一下要將版面調整成什麼樣。剛剛我們設定了內文的寬度是 700，註解部分的內容寬度一定小於140，那就設定成 150，和內文之間留一段空白。&lt;/p&gt;
&lt;p&gt;用下面的指令自動將右邊的註解調到左邊，並重新排版。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt; -d RP/result &lt;span class="o"&gt;||&lt;/span&gt; mkdir RP/result
ls RP &lt;span class="p"&gt;|&lt;/span&gt; grep .png$ &lt;span class="p"&gt;|&lt;/span&gt; xargs -I _IMG_ &lt;span class="se"&gt;\&lt;/span&gt;
convert RP/_IMG_  -print &lt;span class="s2"&gt;&amp;quot;processing RP/%f\\n&amp;quot;&lt;/span&gt; -write mpr:org_pic &lt;span class="se"&gt;\&lt;/span&gt;
        -gravity east -chop 140x0 &lt;span class="se"&gt;\&lt;/span&gt;
        -gravity west -background black -splice 1x0 -background white -splice 1x0 -trim -chop 1x0 +repage &lt;span class="se"&gt;\&lt;/span&gt;
        -gravity center -extent &lt;span class="m"&gt;700&lt;/span&gt; -write mpr:content +delete &lt;span class="se"&gt;\&lt;/span&gt;
    mpr:org_pic &lt;span class="se"&gt;\&lt;/span&gt;
        -gravity east -extent &lt;span class="m"&gt;140&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
                      -background black -splice 1x0 -background white -splice 1x0 -trim -chop 1x0 +repage &lt;span class="se"&gt;\&lt;/span&gt;
        -gravity west -extent &lt;span class="m"&gt;150&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
    mpr:content +append &lt;span class="se"&gt;\&lt;/span&gt;
    RP/result/_IMG_
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;排版 LP&lt;/h4&gt;
&lt;p&gt;重後排版註解在左邊的頁面&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt; -d LP/result &lt;span class="o"&gt;||&lt;/span&gt; mkdir LP/result
ls LP &lt;span class="p"&gt;|&lt;/span&gt; grep .png$ &lt;span class="p"&gt;|&lt;/span&gt; xargs -I _IMG_ &lt;span class="se"&gt;\&lt;/span&gt;
convert LP/_IMG_  -print &lt;span class="s2"&gt;&amp;quot;processing LP/%f\\n&amp;quot;&lt;/span&gt; -write mpr:org_pic &lt;span class="se"&gt;\&lt;/span&gt;
        -gravity west -chop 140x0 &lt;span class="se"&gt;\&lt;/span&gt;
        -gravity east -background black -splice 1x0 -background white -splice 1x0 -trim -chop 1x0 +repage &lt;span class="se"&gt;\&lt;/span&gt;
        -gravity center -extent &lt;span class="m"&gt;700&lt;/span&gt; -write mpr:content +delete &lt;span class="se"&gt;\&lt;/span&gt;
    mpr:org_pic &lt;span class="se"&gt;\&lt;/span&gt;
        -gravity west -extent &lt;span class="m"&gt;140&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
                      -background black -splice 1x0 -background white -splice 1x0 -trim -chop 1x0 +repage &lt;span class="se"&gt;\&lt;/span&gt;
                      -extent &lt;span class="m"&gt;150&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
    mpr:content +append &lt;span class="se"&gt;\&lt;/span&gt;
    LP/result/_IMG_
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;排版 MID&lt;/h4&gt;
&lt;p&gt;只有內文的頁面也需要重新排版&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt; -d mid/result &lt;span class="o"&gt;||&lt;/span&gt; mkdir mid/result
ls mid &lt;span class="p"&gt;|&lt;/span&gt; grep .png$ &lt;span class="p"&gt;|&lt;/span&gt; xargs -I _IMG_ &lt;span class="se"&gt;\&lt;/span&gt;
    convert mid/_IMG_ -print &lt;span class="s2"&gt;&amp;quot;processing mid/%f\\n&amp;quot;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
    -background white -gravity center -extent &lt;span class="m"&gt;700&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
    -gravity east -extent &lt;span class="m"&gt;850&lt;/span&gt; mid/result/_IMG_
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;配置頁面&lt;/h3&gt;
&lt;p&gt;將處理完的圖片集中到 _result 資料夾&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt; -d _result &lt;span class="o"&gt;||&lt;/span&gt; mkdir _result
mv ?P/result/page-???.* mid/result/page-???.* _result
rmdir ?P/result mid/result
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;接下來要為內容加上四周的邊框，示意圖如下：&lt;/p&gt;
&lt;p&gt;&lt;img alt="為內容加上邊框" src="/img/008.png"&gt;&lt;/p&gt;
&lt;p&gt;右邊橙色的部分是故意留下來的空白好做筆記，筆記的寬度設定成主文寬度的 2/5 ，280px&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ls _result/page-???.* &lt;span class="p"&gt;|&lt;/span&gt; xargs -I _IMG_ &lt;span class="se"&gt;\&lt;/span&gt;
mogrify -print &lt;span class="s2"&gt;&amp;quot;processing %f\\n&amp;quot;&lt;/span&gt; -bordercolor white -border 0x80 &lt;span class="se"&gt;\&lt;/span&gt;
    -background white -gravity west -splice 20x0 -gravity east -splice 280x0 &lt;span class="se"&gt;\&lt;/span&gt;
    _IMG_
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;壓縮檔案體積&lt;/h3&gt;
&lt;p&gt;版面配置好後，利用 optipng 對 png 進行編碼最佳化，壓縮檔案的體積&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;optipng _result/page-???.*
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;img alt="利用 optipng 縮小檔案體積" src="/img/009.png"&gt;&lt;/p&gt;
&lt;h3&gt;合併圖片為 PDF&lt;/h3&gt;
&lt;p&gt;用 FreePic2pdf 將圖片合併成 PDF 檔&lt;/p&gt;
&lt;p&gt;&lt;img alt="合併圖片為PDF" src="/img/010.png"&gt;&lt;/p&gt;
&lt;p&gt;最後完成的結果&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;內容是連貫的，沒有左右偏移，而且不會有大段的空白&lt;/li&gt;
&lt;li&gt;註解統一放在左邊&lt;/li&gt;
&lt;li&gt;右方留有足夠的空白可做筆記&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img alt="成果" src="/img/011.png"&gt;&lt;/p&gt;
&lt;h2&gt;忍不住做的實驗&lt;/h2&gt;
&lt;p&gt;在嘗試怎麼用 ImageMagick 調整版面時想到，可不可以直接將分割的圖片串成一個連貫的長圖，這樣不就可以把連貫性做到極緻嗎？實做起來也很簡單，在配置頁面那個步驟，將指令改成&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;convert page-???.* -background white -splice 20x0 &lt;span class="se"&gt;\&lt;/span&gt;
            -gravity east -splice 280x0 &lt;span class="se"&gt;\&lt;/span&gt;
            -gravity north -splice 0x80 -append &lt;span class="se"&gt;\&lt;/span&gt;
            -gravity south -splice 0x80 result.png
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;然後再將 result.png 轉成 PDF 即可。&lt;/p&gt;
&lt;p&gt;&lt;img alt="把頁面全部串起來" src="/img/015.png"&gt;&lt;/p&gt;
&lt;p&gt;能做的事情變多，哎呀，開心死了～&lt;/p&gt;</content></entry></feed>